--- a/species3.qml
+++ b/species3.qml
@@
-    title: "Tonal Counterpoint Species 3 Checker"
-    description: "Checks two-part species 3 counterpoint with passing, neighbor, double neighbor, and cambiata patterns"
+    title: "Tonal Counterpoint Species 4 Checker"
+    description: "Checks two-part species 4 counterpoint with suspensions, retardations, appoggiaturas, and species 3 idioms"
@@
     function isPassingOrNeighborTone(note, prevNote, nextNote, hData) {
         if (!prevNote || !nextNote) return false;
         if (hData.tones.indexOf(note.tpc) !== -1) return true;
@@
         return false;
     }
+
+    // --- SPECIES 4 IDIOMS ---
+
+    function isSuspensionOrRetardation(note, prevNote, nextNote, hData) {
+        if (!prevNote || !nextNote) return { ok: false };
+        if (note.pitch !== prevNote.pitch || note.tpc !== prevNote.tpc) return { ok: false };
+        if (hData.tones.indexOf(note.tpc) !== -1) return { ok: false };
+        var resolution = nextNote.pitch - note.pitch;
+        var absRes = Math.abs(resolution);
+        if (absRes !== 1 && absRes !== 2) return { ok: false };
+        if (resolution < 0) return { ok: true, type: "Suspension" };
+        if (resolution > 0) return { ok: true, type: "Retardation" };
+        return { ok: false };
+    }
+
+    function isAppoggiatura(note, prevNote, nextNote, hData) {
+        if (!prevNote || !nextNote) return false;
+        if (hData.tones.indexOf(note.tpc) !== -1) return false;
+        if (Math.abs(note.pitch - prevNote.pitch) <= 2) return false;
+        if (Math.abs(nextNote.pitch - note.pitch) > 2) return false;
+        return true;
+    }
@@
-                    if (!isStandardNCT && !isPartOfPattern) {
+                    var suspData = isSuspensionOrRetardation(note, prevNote, nextNote, context.hData);
+                    var isAppog = isAppoggiatura(note, prevNote, nextNote, context.hData);
+
+                    if (suspData.ok) {
+                        note.color = colorPattern;
+                    }
+                    else if (isAppog) {
+                        note.color = colorPattern;
+                    }
+                    else if (!isStandardNCT && !isPartOfPattern) {
                         errors.push("Invalid\nNCT");
                         note.color = colorError;
                     }
@@
-        footer.text = "--- SPECIES 3 ANALYSIS ---\nBass Onsets: " + bassOnsets.length + " | Perfect: " + perfRatio + "%\nDouble Neighbors: " + countDN + " | Cambiatas: " + countCambiata;
+        footer.text = "--- SPECIES 4 ANALYSIS ---\nBass Onsets: " + bassOnsets.length + " | Perfect: " + perfRatio + "%\nDouble Neighbors: " + countDN + " | Cambiatas: " + countCambiata;
